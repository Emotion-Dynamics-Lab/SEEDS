---
title: "Step 1 SONA W1 BDI"
author: "Hayleigh Armstrong"
date: "06/10/2025"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

This script will process the data from the SONA W1 - Beck Depression Inventory. 

## Preliminary Steps

Load packages:

```{r, warning = FALSE, message = FALSE, include = FALSE}
library(dplyr)
library(tidyverse)
library(Hmisc)
library(psych)
library(ggplot2)
library(ggcorrplot)
library(reshape2)
```

Read in the data:
```{r}
#For Hayleigh's Mac:
df <- read.csv("/Volumes/Emotion Dynamics Lab/PEARS/Data/SEEDS/PEARS_SEEDS_Demographics___Daily_Surveys_SONA_W1/SEEDS SONA W1 Demographics ExpiWell Data Cleaned.csv", na.strings=c("","NA"))

view(df)
```

Subset the data to just the items from the Beck Depression Inventory and remove rows that have question headers:
```{r}
df_scale <- subset(df, select = c(X.7, X.49:X.68))
df_scale <- df_scale[-c(1,2,3,4),]
head(df_scale)
```

Rename the items:
```{r}
colnames(df_scale)[colnames(df_scale)=="X.7"] <- "id"
colnames(df_scale)[colnames(df_scale)=="X.49"] <- "bdi_1"
colnames(df_scale)[colnames(df_scale)=="X.50"] <- "bdi_2"
colnames(df_scale)[colnames(df_scale)=="X.51"] <- "bdi_3"
colnames(df_scale)[colnames(df_scale)=="X.52"] <- "bdi_4"
colnames(df_scale)[colnames(df_scale)=="X.53"] <- "bdi_5"
colnames(df_scale)[colnames(df_scale)=="X.54"] <- "bdi_6"
colnames(df_scale)[colnames(df_scale)=="X.55"] <- "bdi_7"
colnames(df_scale)[colnames(df_scale)=="X.56"] <- "bdi_8"
colnames(df_scale)[colnames(df_scale)=="X.57"] <- "bdi_9"
colnames(df_scale)[colnames(df_scale)=="X.58"] <- "bdi_10"
colnames(df_scale)[colnames(df_scale)=="X.59"] <- "bdi_11"
colnames(df_scale)[colnames(df_scale)=="X.60"] <- "bdi_12"
colnames(df_scale)[colnames(df_scale)=="X.61"] <- "bdi_13"
colnames(df_scale)[colnames(df_scale)=="X.62"] <- "bdi_14"
colnames(df_scale)[colnames(df_scale)=="X.63"] <- "bdi_15"
colnames(df_scale)[colnames(df_scale)=="X.64"] <- "bdi_16"
colnames(df_scale)[colnames(df_scale)=="X.65"] <- "bdi_17"
colnames(df_scale)[colnames(df_scale)=="X.66"] <- "bdi_18"
colnames(df_scale)[colnames(df_scale)=="X.67"] <- "bdi_19"
colnames(df_scale)[colnames(df_scale)=="X.68"] <- "bdi_20"
head(df_scale)
```


Convert the "prefer not to respond" option to "NA":
```{r}
df_scale[df_scale == 4] <- NA
#View(df_scale)

```


Variables are pulled in as factors and we want to make them numeric values: 
```{r, warning = FALSE}

df_scale[,paste0("bdi_",1:20)] <- lapply(df_scale[,paste0("bdi_",1:20)], as.numeric)
str(df_scale)
```
## Investigating missing data
```{r}

missing_summary <- df_scale %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(),
               names_to = "variable",
               values_to = "n_missing") %>%
  mutate(pct_missing = round((n_missing / nrow(df_scale)) * 100, 2)) %>%
  filter(n_missing > 0) %>%
  arrange(desc(pct_missing))

missing_summary



```

## Calculate the scale

### Calculate the standard mean and sum

Sum and mean scores of Beck Depression Inventory:
```{r}

df_scale$bdi_sum <- apply(df_scale[,paste0("bdi_",1:20)], 1, sum)
df_scale$bdi_mean <- apply(df_scale[,paste0("bdi_",1:20)], 1, mean)

```

Label the items:
```{r}
label(df_scale[["bdi_1"]]) <- "Sadness"
label(df_scale[["bdi_2"]]) <- "Pessimism"
label(df_scale[["bdi_3"]]) <- "Past Failure"
label(df_scale[["bdi_4"]]) <- "Loss of Pleasure"
label(df_scale[["bdi_5"]]) <- "Guilty Feelings"
label(df_scale[["bdi_6"]]) <- "Punishment Feelings"
label(df_scale[["bdi_7"]]) <- "Self-Dislike"
label(df_scale[["bdi_8"]]) <- "Self-Criticalness"
label(df_scale[["bdi_9"]]) <- "Crying"
label(df_scale[["bdi_10"]]) <- "Agitation"
label(df_scale[["bdi_11"]]) <- "Loss of Interest"
label(df_scale[["bdi_12"]]) <- "Indecisiveness"
label(df_scale[["bdi_13"]]) <- "Worthlessness"
label(df_scale[["bdi_14"]]) <- "Loss of Energy"
label(df_scale[["bdi_15"]]) <- "Changes in Sleeping Pattern"
label(df_scale[["bdi_16"]]) <- "Irritability"
label(df_scale[["bdi_17"]]) <- "Changes in Appetite"
label(df_scale[["bdi_18"]]) <- "Concentration Difficulty"
label(df_scale[["bdi_19"]]) <- "Tiredness or Fatigue"
label(df_scale[["bdi_20"]]) <- "Loss of Interest in Sex"

label(df_scale[["bdi_sum"]]) <- "sum of bdi items"
label(df_scale[["bdi_mean"]]) <- "mean of bdi items"

# Look at the data
head(df_scale)
```

Impute missing values for participants who responded to at least 50% of the items (10 items).

First, pull out columns we do not want used in the mean imputation:
```{r}
# Pull out the id column:
df_scale.na <- df_scale
id.list <- df_scale.na$id

#Remove columns we don't want to include in the mean imputation:
df_scale.na <- subset(df_scale.na, select = -c(id, bdi_sum, bdi_mean))
```

Impute the means, using the approach for imputing row means described [here](https://statisticsglobe.com/mean-imputation-for-missing-data/):
```{r}
# Count the number of non-missing items per participant
num_items <- ncol(df_scale.na)
min_items_needed <- ceiling(num_items * 0.5)  # at least 50% answered

# Impute row means only for participants who answered >= 50% of items
for(i in 1:nrow(df_scale.na)) {
  non_missing_count <- sum(!is.na(df_scale.na[i, ]))
  
if(non_missing_count >= min_items_needed) {
    # Impute missing values with row mean
    df_scale.na[i, ][is.na(df_scale.na[i, ])] <- mean(as.numeric(df_scale.na[i, ]), na.rm = TRUE)
  } else {
    # If less than 50% answered, set all values to NA
    df_scale.na[i, ] <- NA
  }
}

```

Round the values back to whole numbers:
```{r}
df_scale.na <- round(df_scale.na, digits=0)
```

Calculate the sum and mean, using the suffix _MI to indicate that these columns have had means imputed:
```{r}
df_scale.na$bdi_sum_MI <- apply(df_scale.na[,paste0("bdi_",1:20)], 1, sum)
df_scale.na$bdi_mean_MI <- apply(df_scale.na[,paste0("bdi_",1:20)], 1, mean)

```

Put the IDs back into the data frame:
```{r}
df_scale.na$id <- id.list

```

Now we need to merge the imputed cases back into the main data frame. We don't want to end up with duplicate rows of data for the cases that had missing values, so first we will remove these cases from the original data frame:
```{r}
df_scale2 <- df_scale[ ! df_scale$id %in% id.list, ]

```

Now add the newly-imputed cases back into the main data frame:
```{r}
# Create columns in df_scale that we will merge the mean-imputed data into
df_scale2$bdi_sum_MI <-df_scale2$bdi_sum
df_scale2$bdi_mean_MI <-df_scale2$bdi_mean

# Create empty columns in df_scale.na for the conventional mean and sum (not MI)
df_scale.na$bdi_sum <-NA
df_scale.na$bdi_mean <-NA

# Order the columns to be consistent for merge
col_order <- c("id", "bdi_1", "bdi_2", "bdi_3", "bdi_4", "bdi_5", "bdi_6", "bdi_7", "bdi_8", "bdi_9", "bdi_10","bdi_11","bdi_12", "bdi_13","bdi_14","bdi_15", "bdi_16", "bdi_17", "bdi_18", "bdi_19","bdi_20", "bdi_sum", "bdi_mean", "bdi_sum_MI",  "bdi_mean_MI")

df_scale2 <- df_scale2[, col_order]
df_scale.na <- df_scale.na[, col_order]

# Merge the imputed cases back into df_scale
df_scale3 <- rbind(df_scale2, df_scale.na)

# Bring in the non-imputed mean and sum from df_scale
df_scale3 <- merge(df_scale3,
                   df_scale[, c("id", "bdi_sum", "bdi_mean")],
                   by = "id",
                   all.x = TRUE,
                   suffixes = c("", "_orig"))

# Reorder columns
df_scale3 <- df_scale3[, c("id", paste0("bdi_", 1:20),
                           "bdi_sum_orig", "bdi_mean_orig",   # non-imputed
                           "bdi_sum_MI", "bdi_mean_MI")]      # imputed
```


Save the data file:
```{r, eval = FALSE}
# Write to Hayleigh's Mac:
write.csv(df_scale,'/Volumes/Emotion Dynamics Lab/PEARS/Data/SEEDS/PEARS_SEEDS_Demographics___Daily_Surveys_SONA_W1/Beck Depression Inventory-Step1_SONA_W1.csv')

```

## Examine the Data

### Reliability
```{r, warning = FALSE}

items <- c("bdi_1",  "bdi_2" , "bdi_3" , "bdi_4" , "bdi_5" , "bdi_6" , "bdi_7" , "bdi_8" , "bdi_9" , "bdi_10" , "bdi_11" , "bdi_12" , "bdi_13" , "bdi_14" , "bdi_15" , "bdi_16" , "bdi_17" , "bdi_18" , "bdi_19" , "bdi_20")
alpha(df_scale3[,items])

```

### Descriptive statistics
```{r}
describe(df_scale3$bdi_sum_MI)
describe(df_scale3$bdi_mean_MI)
```


### Histogram
```{r, warning = FALSE, message = FALSE}

qplot(df_scale3$bdi_sum_MI, geom="histogram") 
qplot(df_scale3$bdi_mean_MI, geom="histogram")

```

