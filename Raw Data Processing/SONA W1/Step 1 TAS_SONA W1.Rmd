---
title: "Step 1 TAS_SONA W1"
author: "Hayleigh Armstrong"
date: "Last compiled on r format(Sys.time(), '%d %B, %Y')"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

## Preliminary Steps

Load packages:
```{r, warning = FALSE, message = FALSE, include = FALSE}
library(dplyr)
library(tidyverse)
library(Hmisc)
library(psych)
library(ggplot2)
library(ggcorrplot)
library(reshape2)
```

Read in the data:
```{r}
# Hayleigh's Mac:
df <- read.csv("/Volumes/Emotion Dynamics Lab/PEARS/Data/SEEDS/PEARS_SEEDS_Demographics___Daily_Surveys_SONA_W1/SEEDS SONA W1 Demographics ExpiWell Data Cleaned.csv", na.strings=c("","NA"))

```

Subset the data to just the items from the Toronto Alexthymia Scale questionnaire and remove rows that have question headers:
```{r}
tas_scale <- select(df [-c(1,2,3,4),], X.7, X.152:X.171)
head(tas_scale)
```

Rename the items:
```{r}
colnames(tas_scale)[colnames(tas_scale)=="X.7"] <- "id"
colnames(tas_scale)[colnames(tas_scale)=="X.152"] <- "tas_1"
colnames(tas_scale)[colnames(tas_scale)=="X.153"] <- "tas_2"
colnames(tas_scale)[colnames(tas_scale)=="X.154"] <- "tas_3"
colnames(tas_scale)[colnames(tas_scale)=="X.155"] <- "tas_4"
colnames(tas_scale)[colnames(tas_scale)=="X.156"] <- "tas_5"
colnames(tas_scale)[colnames(tas_scale)=="X.157"] <- "tas_6"
colnames(tas_scale)[colnames(tas_scale)=="X.158"] <- "tas_7"
colnames(tas_scale)[colnames(tas_scale)=="X.159"] <- "tas_8"
colnames(tas_scale)[colnames(tas_scale)=="X.160"] <- "tas_9"
colnames(tas_scale)[colnames(tas_scale)=="X.161"] <- "tas_10"
colnames(tas_scale)[colnames(tas_scale)=="X.162"] <- "tas_11"
colnames(tas_scale)[colnames(tas_scale)=="X.163"] <- "tas_12"
colnames(tas_scale)[colnames(tas_scale)=="X.164"] <- "tas_13"
colnames(tas_scale)[colnames(tas_scale)=="X.165"] <- "tas_14"
colnames(tas_scale)[colnames(tas_scale)=="X.166"] <- "tas_15"
colnames(tas_scale)[colnames(tas_scale)=="X.167"] <- "tas_16"
colnames(tas_scale)[colnames(tas_scale)=="X.168"] <- "tas_17"
colnames(tas_scale)[colnames(tas_scale)=="X.169"] <- "tas_18"
colnames(tas_scale)[colnames(tas_scale)=="X.170"] <- "tas_19"
colnames(tas_scale)[colnames(tas_scale)=="X.171"] <- "tas_20"
```

Variables are pulled in as factors and we want to make them numeric values:
```{r}
tas_scale[,paste0("tas_",1:20)] <- lapply(tas_scale[,paste0("tas_",1:20)], as.numeric)
str(tas_scale)
```

Label the items:
```{r}
label(tas_scale[["tas_1"]]) <- "I am confused about what emotion I am feeling"
label(tas_scale[["tas_2"]]) <- "It is difficult for me to find the right words for my feelings"
label(tas_scale[["tas_3"]]) <- "I have physical sensations that even doctors don’t understand"
label(tas_scale[["tas_4"]]) <- "I am able to describe my feelings easily"
label(tas_scale[["tas_5"]]) <- "I prefer to analyze problems rather than just describe them"
label(tas_scale[["tas_6"]]) <- "When I am upset, I don’t know if I am sad, frightened, or angry?"
label(tas_scale[["tas_7"]]) <- "I am often troubled by sensations in my body"
label(tas_scale[["tas_8"]]) <- "I prefer to just let thing happen rather than to understand why they turned out that way"
label(tas_scale[["tas_9"]]) <- "I have feelings that I can’t quite identify"
label(tas_scale[["tas_10"]]) <- "Being in touch with emotions is essential"
label(tas_scale[["tas_11"]]) <- "I find it hard to describe how I feel about people"
label(tas_scale[["tas_12"]]) <- "People tell me to describe my feelings more"
label(tas_scale[["tas_13"]]) <- "I don’t know what’s going on inside me"
label(tas_scale[["tas_14"]]) <- "I often don’t know why I am angry"
label(tas_scale[["tas_15"]]) <- "I prefer to talk to people about their daily lives rather than their feelings"
label(tas_scale[["tas_16"]]) <- "I prefer to watch “light” entertainment shows rather than psychological dramas"
label(tas_scale[["tas_17"]]) <- "It is difficult for me to reveal my innermost feelings, even to close friends"
label(tas_scale[["tas_18"]]) <- "I can feel close to someone, even in moments of silence"
label(tas_scale[["tas_19"]]) <- "I find examination of my feelings useful in solving personal problems"
label(tas_scale[["tas_20"]]) <- "Looking for hidden meanings in in movies or plays distracts from my enjoyment"

# Look at the data
head(tas_scale)
```

Reverse code items 4, 5, 10, 18, and 19
```{r}

tas_scale <- tas_scale %>%
  mutate(
    tas_4 = 6 - tas_4,
    tas_5 = 6 - tas_5,
    tas_10 = 6 - tas_10,
    tas_18 = 6 - tas_18,
    tas_19 = 6 - tas_19,
  )

```

## Calculate the scale

### Calculate standard means and sums

Calculate the sum scores of Toronto Alexthymia Scale and Subscales, in line with the instructions described in (https://contextualscience.org/toronto_alexithymia_scale_tas20)

First, calculate the sum and the mean scores (non-MI):
```{r}

# Total alexithymia score = sum all subscales
# Scoring range: 20-100 (higher scores = greater challenges)
tas_scale$tas_sum <- apply(tas_scale[,paste0("tas_",1:20)], 1, sum)

tas_scale$tas_mean <- apply(tas_scale[,paste0("tas_",1:20)], 1, mean)

label(tas_scale$tas_sum) <- "sum of tas items"
label(tas_scale$tas_mean) <- "mean of tas items"
```

Calculate sum and mean scores of the 3 subscales (non-MI):
```{r}

# Factor I: Difficulty identifying feelings (Items 1, 3, 6, 7, 9, 13, 14)
tas_scale$tas_diff_id_sum <- apply(tas_scale[,paste0("tas_", c(1,3,6,7,9,13,14))], 1, sum)
tas_scale$tas_diff_id_mean <- apply(tas_scale[,paste0("tas_", c(1,3,6,7,9,13,14))], 1, mean)

# Factor II:Difficulty describing feelings (Items 2, 4R, 11, 12, 17)
tas_scale$tas_diff_describ_sum <- apply(tas_scale[,paste0("tas_", c(2,4,11,12,17))], 1, sum)
tas_scale$tas_diff_describ_mean <- apply(tas_scale[,paste0("tas_", c(2,4,11,12,17))], 1, mean)

#Factor III: Externally-oriented thinking (Items 5R, 8, 10R, 15, 16, 18R, 19R, 20)
tas_scale$tas_ext_think_sum <- apply(tas_scale[,paste0("tas_", c(5,8,10,15,16,18,19,20))], 1, sum)
tas_scale$tas_ext_think_mean <- apply(tas_scale[,paste0("tas_", c(5,8,10,15,16,18,19,20))], 1, mean)

label(tas_scale$tas_diff_id_sum) <- "sum of difficulty identifying feelings items"
label(tas_scale$tas_diff_id_mean) <- "mean of difficulty identifying feelings items"

label(tas_scale$tas_diff_describ_sum) <- "sum of difficulty describing feelings items"
label(tas_scale$tas_diff_describ_mean) <- "mean of difficulty describing feelings items"

label(tas_scale$tas_ext_think_sum) <- "sum of externally-oriented thinking items"
label(tas_scale$tas_ext_think_mean) <- "mean of externally-oriented thinking items"

```

### Look at missing data - impute means for missing values

```{r}

missing_summary <- tas_scale %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(),
               names_to = "variable",
               values_to = "n_missing") %>%
  mutate(pct_missing = round((n_missing / nrow(tas_scale)) * 100, 2)) %>%
  filter(n_missing > 0) %>%
  arrange(desc(pct_missing))

missing_summary
```

Remove unneeded columns, including the ID so it doesn't get used in the mean imputation:
```{r}
# First, pull out the ID column:
tas_scale.na <- tas_scale
id.list <- tas_scale.na$id

# Now remove the columns we don't want to be part of the mean imputation 
tas_scale.na <- subset(tas_scale.na, select= -c(id, tas_sum, tas_mean, tas_diff_id_mean, tas_diff_id_sum, tas_diff_describ_sum, tas_diff_describ_mean, tas_ext_think_mean, tas_ext_think_sum)) 


```


Impute the means, using the approach for imputing row means described [here](https://statisticsglobe.com/mean-imputation-for-missing-data/):

Note from Jess: double check how this works and do separately (?) if needed for subscales
```{r}
# Count the number of non-missing items per participant
num_items <- ncol(tas_scale.na)
min_items_needed <- ceiling(num_items * 0.5)  # at least 50% answered

# Impute row means only for participants who answered >= 50% of items
for(i in 1:nrow(tas_scale.na)) {
  non_missing_count <- sum(!is.na(tas_scale.na[i, ]))
  
if(non_missing_count >= min_items_needed) {
    # Impute missing values with row mean
    tas_scale.na[i, ][is.na(tas_scale.na[i, ])] <- mean(as.numeric(tas_scale.na[i, ]), na.rm = TRUE)
  } else {
    # If less than 50% answered, set all values to NA
    tas_scale.na[i, ] <- NA
  }
}

```

Round the values back to whole numbers:
```{r}
tas_scale.na <- round(tas_scale.na, digits=0)
```

Calculate the sum and mean, using the suffix _MI to indicate that these columns have had means imputed:
```{r}
tas_scale.na$tas_sum_MI <- apply(tas_scale.na[,paste0("tas_",1:20)], 1, sum)
tas_scale.na$tas_mean_MI <- apply(tas_scale.na[,paste0("tas_",1:20)], 1, mean)

```

Put the IDs back into the data frame:
```{r}
tas_scale.na$id <- id.list

#Put the MI columns back into the original data frame
tas_scale$tas_mean_MI <- tas_scale.na$tas_mean_MI
tas_scale$tas_sum_MI  <- tas_scale.na$tas_sum_MI
```


```


```{r}
# Reorder columns
tas_scale3 <- tas_scale3[, c("id", paste0("tas_", 1:20),
                           "tas_sum_orig", "tas_mean_orig", "tas_diff_id_sum","tas_diff_id_mean", "tas_diff_describ_sum", "tas_diff_describ_mean", "tas_ext_think_sum", "tas_ext_think_mean",
                           "tas_sum_MI", "tas_mean_MI")]      # imputed
```

Save the data file:
```{r, eval = FALSE}
#Save to Hayleigh's Mac:
write.csv(tas_scale3,'/Volumes/Emotion Dynamics Lab/PEARS/Data/SEEDS/PEARS_SEEDS_Demographics___Daily_Surveys_SONA_W1/SONA W1 Perceived Stress Part 1.csv')

#Save to Jess's Mac:


```

## Examine the Data # Need to add reliability analyses for individual subscales

### Reliability

```{r, warning = FALSE}
items <- c("tas_1", "tas_2", "tas_3", "tas_4", "tas_5", "tas_6", "tas_7", "tas_8", "tas_9", "tas_10", "tas_11","tas_12","tas_13","tas_14","tas_15","tas_16","tas_17","tas_18","tas_19","tas_20")

alpha(tas_scale3[,items])
```

### Descriptive statistics
```{r}
describe(tas_scale3$tas_sum_MI)
describe(tas_scale3$tas_mean_MI)
```

### Histograms

```{r, message = FALSE, warning = FALSE}
qplot(tas_scale3$tas_sum_MI, geom="histogram") 

qplot(tas_scale3$tas_mean_MI, geom="histogram")
```

