---
title: "COMM W1 Demographics"
author: "Hayleigh Armstrong"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

This script will process the data from the COMM W1 - Demographics Questionnaire.

## Preliminary Steps

Load packages:

```{r, warning = FALSE, message = FALSE, include = FALSE}
library(plyr)
library(dplyr)
library(tidyverse)
library(tibble)
library(Hmisc)
library(psych)
library(ggplot2)
library(ggcorrplot)
library(reshape2)
library(lubridate)

```

Read in the data:
```{r}
#Hayleigh's Mac:
df <- read.csv("/Volumes/Emotion Dynamics Lab/PEARS/Data/SEEDS/PEARS_SEEDS_Demographics___Daily_Surveys_COMM_W1/SEEDS COMM W1 Demographics ExpiWell Data Cleaned.csv", na.strings=c("","NA"))

```

Subset the data to just the items from the Demographics Questionnaire and remove rows that have question headers:
```{r}
demo_scale <- subset(df, select = c(X, X.1, X.7, X.13:X.19, X.21:X.42))
demo_scale <- demo_scale[-c(1,2,3,4),]
head(demo_scale)
```

## Clean up the variables

Rename the items:
```{r}

colnames(demo_scale)[colnames(demo_scale)=="X"] <- "StartDate"
colnames(demo_scale)[colnames(demo_scale)=="X.1"] <- "EndDate"

colnames(demo_scale)[colnames(demo_scale)=="X.7"] <- "id"
colnames(demo_scale)[colnames(demo_scale)=="X.13"] <- "GenderSelfDescribeText"
colnames(demo_scale)[colnames(demo_scale)=="X.14"] <- "GenderTrajectory"
colnames(demo_scale)[colnames(demo_scale)=="X.15"] <- "GenderTrajectoryNeitherCisgenderNorTransgenderText"
colnames(demo_scale)[colnames(demo_scale)=="X.16"] <- "GenderTrajectoryUnsureText"
colnames(demo_scale)[colnames(demo_scale)=="X.17"] <- "GenderBinaryRelation"
colnames(demo_scale)[colnames(demo_scale)=="X.18"] <- "GenderNietherBinaryNorNonbinaryText"
colnames(demo_scale)[colnames(demo_scale)=="X.19"] <- "GenderBinaryRelationUnsureText"

# Column X.20 was deleted as it was blank

colnames(demo_scale)[colnames(demo_scale)=="X.21"] <- "SexualityAsexualAceSpectrum"
colnames(demo_scale)[colnames(demo_scale)=="X.22"] <- "SexualityBisexual"
colnames(demo_scale)[colnames(demo_scale)=="X.23"] <- "SexualityGay"
colnames(demo_scale)[colnames(demo_scale)=="X.24"] <- "SexualityLesbian"
colnames(demo_scale)[colnames(demo_scale)=="X.25"] <- "SexualityPansexual"
colnames(demo_scale)[colnames(demo_scale)=="X.26"] <- "SexualityQueer"
colnames(demo_scale)[colnames(demo_scale)=="X.27"] <- "SexualityStraightHeterosexual"
colnames(demo_scale)[colnames(demo_scale)=="X.28"] <- "SexualityPreferNotToSay"
colnames(demo_scale)[colnames(demo_scale)=="X.29"] <- "SexualitySelfDescribeText"

colnames(demo_scale)[colnames(demo_scale)=="X.30"] <- "BirthMonth"
colnames(demo_scale)[colnames(demo_scale)=="X.31"] <- "BirthYear"

colnames(demo_scale)[colnames(demo_scale)=="X.32"] <- "EthnicityAsian"
colnames(demo_scale)[colnames(demo_scale)=="X.33"] <- "EthnicityBlackAfrican"
colnames(demo_scale)[colnames(demo_scale)=="X.34"] <- "EthnicityHispanicLatino"
colnames(demo_scale)[colnames(demo_scale)=="X.35"] <- "EthnicityIndigenous"
colnames(demo_scale)[colnames(demo_scale)=="X.36"] <- "EthnicityMiddleEasternNorthAfrican"
colnames(demo_scale)[colnames(demo_scale)=="X.37"] <- "EthnicityPacificIslander"
colnames(demo_scale)[colnames(demo_scale)=="X.38"] <- "EthnicityWhiteEuropean"
colnames(demo_scale)[colnames(demo_scale)=="X.39"] <- "EthnicityPreferNotToSay"
colnames(demo_scale)[colnames(demo_scale)=="X.40"] <- "EthnicitySelfDescribeText"

colnames(demo_scale)[colnames(demo_scale)=="X.41"] <- "Ladder"

colnames(demo_scale)[colnames(demo_scale)=="X.42"] <- "Feedback"

```

Change/fix responses to be accurate/meaningful:
```{r}
#Change 0 to NA 
demo_scale[demo_scale == 0] <- NA 

#Change Gender Identity responses to text 
demo_scale$GenderTrajectory[demo_scale$GenderTrajectory == 1] <- "trans/transgender"
demo_scale$GenderTrajectory[demo_scale$GenderTrajectory == 2] <- "cisgender"
demo_scale$GenderTrajectory[demo_scale$GenderTrajectory == 3] <- "neither_transgender_nor_cisgender"
demo_scale$GenderTrajectory[demo_scale$GenderTrajectory == 4] <- "unsure_gender_trajectory"
#For "GenderTrajectoryNeitherCisgenderNorTransgenderText", 2 participants answered "male"/"Male", change these participants' gender trajectory responses to NA:
demo_scale[demo_scale$id == "6801743c3df92472ed0ca4cd", 
           c("GenderTrajectoryNeitherCisgenderNorTransgenderText", 
             "GenderTrajectory")] <- NA
demo_scale[demo_scale$id == "68079a6d08fd72522057c691", 
           c("GenderTrajectoryNeitherCisgenderNorTransgenderText", 
             "GenderTrajectory")] <- NA

demo_scale$GenderBinaryRelation[demo_scale$GenderBinaryRelation == 1] <- "binary"
demo_scale$GenderBinaryRelation[demo_scale$GenderBinaryRelation == 2] <- "nonbinary"
demo_scale$GenderBinaryRelation[demo_scale$GenderBinaryRelation == 3] <- "niether_binary_nor_nonbinary"
demo_scale$GenderBinaryRelation[demo_scale$GenderBinaryRelation == 4] <- "gender_binary_unsure"
# 1 participant was confused by the gender binary question. Change their answers to NA
demo_scale[demo_scale$id == "6803418d3df92472ed22e910", 
           c("GenderBinaryRelationUnsureText", 
             "GenderBinaryRelation")] <- NA
# 1 participant answered "Nothing much" to the gender binary question. Change their answers to NA
demo_scale[demo_scale$id == "681a4ba207710cff0ab2216f", 
           c("GenderNietherBinaryNorNonbinaryText", 
             "GenderBinaryRelation")] <- NA

#Change Gender SelfDescribe responses to be a consistent formatting:
demo_scale$GenderSelfDescribeText <- tolower(trimws(demo_scale$GenderSelfDescribeText)) #removes extra spaces and turns responses lowercase
# Create "man" category:
demo_scale$GenderSelfDescribeText[demo_scale$GenderSelfDescribeText %in% c("make", "male", "man", "man male")] <- "man"
# Create "woman" category:
demo_scale$GenderSelfDescribeText[demo_scale$GenderSelfDescribeText %in% c("women","women, bisexual", "f", "female", "woman", "woman, she/her" )] <- "woman"
# Create "genderfluid" category:
demo_scale$GenderSelfDescribeText[demo_scale$GenderSelfDescribeText %in% c("genderfluid", "gender fluid" )] <- "genderfluid"
# Assign nonsensicial values as NA:
demo_scale$GenderSelfDescribeText[demo_scale$GenderSelfDescribeText %in% c("[]")] <- NA
table(demo_scale$GenderSelfDescribeText)

#Change Sexuality responses to text
demo_scale$SexualityAsexualAceSpectrum[demo_scale$SexualityAsexualAceSpectrum == 1] <- "asexual"
demo_scale$SexualityBisexual[demo_scale$SexualityBisexual == 1] <- "bisexual"
demo_scale$SexualityGay[demo_scale$SexualityGay == 1] <- "gay"
demo_scale$SexualityLesbian[demo_scale$SexualityLesbian == 1] <- "lesbian"
demo_scale$SexualityPansexual[demo_scale$SexualityPansexual == 1] <- "pansexual"
demo_scale$SexualityQueer[demo_scale$SexualityQueer == 1] <- "queer"
demo_scale$SexualityStraightHeterosexual[demo_scale$SexualityStraightHeterosexual == 1] <- "straight/heterosexual"
demo_scale$SexualityPreferNotToSay[demo_scale$SexualityPreferNotToSay == 1] <- NA


#Change Ethnicity responses to text

demo_scale$EthnicityAsian[demo_scale$EthnicityAsian == 1] <- "Asian"
demo_scale$EthnicityBlackAfrican[demo_scale$EthnicityBlackAfrican == 1] <- "Black/African"
demo_scale$EthnicityHispanicLatino[demo_scale$EthnicityHispanicLatino == 1] <- "Hispanic/Latino"
demo_scale$EthnicityIndigenous[demo_scale$EthnicityIndigenous == 1] <- "Indigenous"
demo_scale$EthnicityMiddleEasternNorthAfrican[demo_scale$EthnicityMiddleEasternNorthAfrican == 1] <- "Middle_Eastern/North_African"
demo_scale$EthnicityPacificIslander[demo_scale$EthnicityPacificIslander == 1] <- "Pacific_Islander"
demo_scale$EthnicityWhiteEuropean[demo_scale$EthnicityWhiteEuropean == 1] <- "White/European"
demo_scale$EthnicityPreferNotToSay[demo_scale$EthnicityPreferNotToSay == 1] <- NA


#Ladder SES Q - Reverse code to match question text, came in backwards
demo_scale$Ladder <- as.numeric(demo_scale$Ladder)
#demo_scale$Ladder[demo_scale$Ladder == 11] <- NA (No prefer not to respond option) 
demo_scale$Ladder <- 11 - demo_scale$Ladder

```

Age math:
```{r}
#Option 1:

# Convert entries for BirthMonth to numeric values:

# Step 1: Remove spaces and make lowercase
demo_scale$BirthMonth <- tolower(trimws(demo_scale$BirthMonth))

# Step 2: Convert numeric strings to numbers
demo_scale$BirthMonth[demo_scale$BirthMonth %in% as.character(1:12)] <- as.numeric(demo_scale$BirthMonth[demo_scale$BirthMonth %in% as.character(1:12)])


# Step 3: Convert month names/abbreviations - use table() function to look for "weird" entries
demo_scale$BirthMonth[demo_scale$BirthMonth %in% c("january", "janvier")] <- 1
demo_scale$BirthMonth[demo_scale$BirthMonth %in% c("february", "feb")] <- 2
demo_scale$BirthMonth[demo_scale$BirthMonth %in% c("march", "march 1st, 2002")] <- 3
demo_scale$BirthMonth[demo_scale$BirthMonth %in% c("april", "apr")] <- 4
demo_scale$BirthMonth[demo_scale$BirthMonth == "may"] <- 5
demo_scale$BirthMonth[demo_scale$BirthMonth == "june"] <- 6
demo_scale$BirthMonth[demo_scale$BirthMonth == "july"] <- 7
demo_scale$BirthMonth[demo_scale$BirthMonth %in% c("august")] <- 8
demo_scale$BirthMonth[demo_scale$BirthMonth %in% c("september", "0\nseptember", "09")] <- 9
demo_scale$BirthMonth[demo_scale$BirthMonth %in% c("october", "oct")] <- 10
demo_scale$BirthMonth[demo_scale$BirthMonth %in% c("november", "nov")] <- 11
demo_scale$BirthMonth[demo_scale$BirthMonth %in% c("december", "dec")] <- 12
demo_scale$BirthMonth[demo_scale$BirthMonth %in% c("2001", "23", "n/a")] <- NA
demo_scale$BirthMonth[demo_scale$id == "680a387c19ce95348696b2fc"] <- 7 #Had to hardcode this response as P entered their birthdate in 'date' format

# Step 4: convert the column to numeric type
demo_scale$BirthMonth <- as.numeric(demo_scale$BirthMonth)

table(demo_scale$BirthMonth) # check to make sure

# START HERE NEXT

# Clean up BirthYear column 
# Remove extra spaces and convert to character string temporarily
demo_scale$BirthYear <- trimws(as.character(demo_scale$BirthYear))

# Manually code any entries that need to be fixed
demo_scale$BirthYear[demo_scale$BirthYear %in% c(".2007", "2007", "20073")] <- "2007"
demo_scale$BirthYear[demo_scale$BirthYear %in% c("00", "2000")] <- "2000"
demo_scale$BirthYear[demo_scale$BirthYear %in% c("01", "2001")] <- "2001"

# Clean up BirthYear column to keep 4-digit numbers
demo_scale <- demo_scale %>%
  mutate(
    BirthYear = ifelse(grepl("^[0-9]{4}$", BirthYear), 
                       as.numeric(BirthYear), 
                       NA))

table(demo_scale$BirthYear) # check to make sure.

# NOTE: There are 36 participants born before 2000. We decided to include them, but we will need to review this when writing our paper (i.e., is the focus on emerging adults or adults more generally?)

# Concatenate month and year data:
demo_scale$BirthMonth_Year <- paste(demo_scale$BirthYear, "-", demo_scale$BirthMonth)
typeof(demo_scale$BirthMonth_Year)

# Remove spaces
demo_scale$BirthMonth_Year <- gsub(" ", "", demo_scale$BirthMonth_Year, fixed = TRUE)

# Turn into date format
demo_scale$BirthMonth_Year <- ym(demo_scale$BirthMonth_Year)

# Truncate the `StartDate` variable so it contains only year and month information:
demo_scale$StartDate2 <- demo_scale$StartDate
typeof(demo_scale$StartDate2)

# Keep just the X characters from the left (ymd)
demo_scale$StartDate2 <-substr(demo_scale$StartDate2, 1, 10)
demo_scale$StartDate2 <- as.Date(demo_scale$StartDate2, format = "%m/%d/%Y")
typeof(demo_scale$StartDate2)
```

Do some calendar math to calculate age:
```{r}
demo_scale$Age_Days <- demo_scale$StartDate2 - demo_scale$BirthMonth_Year

# note: there may be a more precise way to calculate this with lubridate given that not all years are 365 days in length
demo_scale$Age_Years <- demo_scale$Age_Days/365.25
# Strip days
demo_scale$Age_Years <-substr(demo_scale$Age_Years, 1, 8)
demo_scale$Age_Years <- as.numeric(demo_scale$Age_Years)
describe(demo_scale$Age_Years)

# Calculate age in years using lubridate.
demo_scale$Age_Years2 <-year(as.period(interval(demo_scale$BirthMonth_Year, demo_scale$StartDate2)))

demo_scale$Age_Years2 <- car::recode(demo_scale$Age_Years2, "'4' = 18")

describe(demo_scale$Age_Years2)

```


Concatenate into single column for each multiple response option question:
```{r}

#Gender Identity
demo_scale <- demo_scale %>%
  unite("GenderIdentity", c("GenderSelfDescribeText":"GenderNietherBinaryNorNonbinaryText","GenderBinaryRelationUnsureText"), sep= "-", 
        remove = FALSE, na.rm = TRUE)

#Sexual Orientation
demo_scale <- demo_scale %>%
  unite("SexualOrientation", c("SexualityAsexualAceSpectrum":"SexualityPreferNotToSay","SexualitySelfDescribeText"), sep= "-", 
        remove = FALSE, na.rm = TRUE)
demo_scale$SexualOrientation[demo_scale$SexualOrientation == ""] <- NA

#Ethnicity
demo_scale <- demo_scale %>%
  unite("Ethnicity", c("EthnicityAsian":"EthnicityPreferNotToSay","EthnicitySelfDescribeText"), sep= "-", 
        remove = FALSE, na.rm = TRUE)

```

Calculate a variable indicating sexual and gender minority (SGM) status. We want to code everyone who indicated both cisgender, binary, and heterosexual into `0` and everyone else into `1`.
```{r}
# First recode to a gender minority variable. Note that this is using car, not dplyr

demo_scale$gender_selfdescribe_minority <- car::recode(
  demo_scale$GenderSelfDescribeText,
  "'woman' = 0; 'man' = 0; else = 1"
)
                                                      

demo_scale$gender_trajectory_minority <- car::recode(demo_scale$GenderTrajectory, "'cisgender' = 0; 
                             'trans/transgender' = 1; 
                             'neither_transgender_nor_cisgender' = 1; 
                             'unsure_gender_trajectory' = 1")

demo_scale$gender_binary_minority <- car::recode(demo_scale$GenderBinaryRelation, "'binary' = 0; 
                             'nonbinary' = 1; 
                             'niether_binary_nor_nonbinary' = 1; 
                             'gender_binary_unsure' = 1")

# Now recode sexual_orientation into a sexual minority indicator
demo_scale$sexual_minority <- car::recode(
  demo_scale$SexualOrientation, 
  "'straight/heterosexual' = 0; else = 1")

# --- Ensure all are numeric ---
demo_scale <- demo_scale %>%
  mutate(
    across(
      c(gender_selfdescribe_minority,
        gender_trajectory_minority,
        gender_binary_minority,
        sexual_minority),
      as.numeric))

# --- Create Overall Sexual/Gender Minority (SGM) variable ---
demo_scale$sgm <- pmax(
  demo_scale$gender_selfdescribe_minority,
  demo_scale$gender_trajectory_minority,
  demo_scale$gender_binary_minority,
  demo_scale$sexual_minority,
  na.rm = TRUE
)
                  
# Make sure all NA rows (if all 4 inputs are NA) stay NA
demo_scale$sgm[is.na(demo_scale$gender_selfdescribe_minority) &
               is.na(demo_scale$gender_trajectory_minority) &
               is.na(demo_scale$gender_binary_minority) &
               is.na(demo_scale$sexual_minority)] <- NA

# --- Check distribution ---
table(demo_scale$sgm, useNA = "ifany")

```



## Save the file

Save cleaned datasets:
```{r}
#Write to Hayleigh's Mac:
write.csv(demo_scale,'/Volumes/Emotion Dynamics Lab/PEARS/Data/SEEDS/PEARS_SEEDS_Demographics___Daily_Surveys_SONA_W1/SONA W1 Demographics Cleaned Full Part 1.csv')

# Second dataset with just one column per question plus GSM:
demo_core <- subset(demo_scale, select = c(id, sgm, GenderIdentity, SexualOrientation, Ethnicity, Age_Years, Ladder))
write.csv(demo_core,'/Volumes/Emotion Dynamics Lab/PEARS/Data/SEEDS/PEARS_SEEDS_Demographics___Daily_Surveys_SONA_W1/SONA W1 Demographics Cleaned Short Part 1.csv')

#Write to Jess's Mac: 


```